<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Equipment Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        /* Mobile Safe Area spacing */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Calendar as CalendarIcon, Truck, DollarSign, Wrench, ChevronLeft, ChevronRight, Search, CheckCircle, AlertCircle, AlertTriangle, Clock, Pencil, Save, X, Database, BarChart3, TrendingUp, TrendingDown, Lock, CheckSquare, History, Menu, List } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from "firebase/app";
        import { 
          getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, 
          query, getDocs, writeBatch, setDoc 
        } from "firebase/firestore";
        import { 
          getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from "firebase/auth";

        // --- Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyATXRPfV9NgttQ3ompCk-xeVOqvm6uIU6s",
          authDomain: "equipmenttracker-857f8.firebaseapp.com",
          projectId: "equipmenttracker-857f8",
          storageBucket: "equipmenttracker-857f8.firebasestorage.app",
          messagingSenderId: "1088031272040",
          appId: "1:1088031272040:web:44cd3b106b66f2535a5fdd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Mock Data ---
        const SEED_MACHINES = [
          { id: "1", name: 'CAT 329E L Excavator', type: 'Excavator', loan: { active: true, payment: 2500, interest: 5.5 }, maintenance: { nextDate: '2025-12-15', frequency: 'Monthly' }, baseRate: 1000 },
          { id: "2", name: 'Bobcat T66 Loader', type: 'Track Loader', loan: { active: true, payment: 900, interest: 4.2 }, maintenance: { nextDate: '2026-03-01', frequency: 'Quarterly' }, baseRate: 300 },
          { id: "3", name: 'Bobcat T66 Loader 2', type: 'Track Loader', loan: { active: true, payment: 800, interest: 4.0 }, maintenance: { nextDate: '2026-02-20', frequency: 'Monthly' }, baseRate: 250 },
          { id: "4", name: 'CAT 259D3 Loader', type: 'Track Loader', loan: { active: false, payment: 0, interest: 0 }, maintenance: { nextDate: '2026-03-10', frequency: 'Monthly' }, baseRate: 300 },
          { id: "5", name: 'Toro Dingo TX 427', type: 'Mini Loader', loan: { active: false, payment: 0, interest: 0 }, maintenance: { nextDate: '2026-04-15', frequency: 'Annually' }, baseRate: 200 },
          { id: "6", name: 'CAT 236D Skidsteer', type: 'Skid Steer', loan: { active: true, payment: 650, interest: 3.8 }, maintenance: { nextDate: '2026-02-28', frequency: 'Quarterly' }, baseRate: 250 },
          { id: "7", name: 'John Deere 317G', type: 'Track Loader', loan: { active: true, payment: 750, interest: 3.9 }, maintenance: { nextDate: '2026-03-05', frequency: 'Monthly' }, baseRate: 250 },
          { id: "8", name: 'Terex T16 Mini', type: 'Mini Excavator', loan: { active: false, payment: 0, interest: 0 }, maintenance: { nextDate: '2026-03-20', frequency: 'Quarterly' }, baseRate: 200 }
        ];

        const SEED_TRANSACTIONS = [
          { machineId: "1", type: 'rental', customer: 'Heavy Duty Construction', startDate: '2026-02-01', endDate: '2026-02-15', rate: 1000 },
          { machineId: "2", type: 'rental', customer: 'Local Landscapers', startDate: '2026-02-10', endDate: '2026-02-12', rate: 300 },
          { machineId: "5", type: 'rental', customer: 'Backyard Renos', startDate: '2026-02-20', endDate: '2026-02-22', rate: 200 },
        ];

        const SEED_MAINTENANCE = [
          { machineId: "1", description: 'Hydraulic System Check', cost: 450, status: 'complete', date: '2026-01-15', completedAt: '2026-01-15T10:00:00Z' },
          { machineId: "3", description: 'Oil Change', cost: 120, status: 'complete', date: '2026-01-20', completedAt: '2026-01-20T14:30:00Z' }
        ];

        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const formatDate = (dateString) => {
          if (!dateString) return '';
          const options = { month: 'short', day: 'numeric', year: 'numeric' };
          return new Date(dateString).toLocaleDateString(undefined, options);
        };

        // --- Components ---

        // 1. Add Machine Screen
        const AddMachine = ({ onAdd, onCancel }) => {
          const [form, setForm] = useState({
            name: '', type: 'Excavator', baseRate: '', 
            hasLoan: false, loanPayment: '', loanInterest: '',
            maintNext: '', maintFreq: 'Monthly'
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            onAdd({
              name: form.name,
              type: form.type,
              baseRate: Number(form.baseRate),
              loan: { active: form.hasLoan, payment: form.hasLoan ? Number(form.loanPayment) : 0, interest: form.hasLoan ? Number(form.loanInterest) : 0 },
              maintenance: { nextDate: form.maintNext, frequency: form.maintFreq }
            });
          };

          return (
            <div className="max-w-2xl mx-auto bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-lg md:text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <Truck className="w-6 h-6 text-blue-600" /> Add New Equipment
              </h2>
              <form onSubmit={handleSubmit} className="space-y-4 md:space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Machine Name</label>
                    <input required type="text" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                      value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="e.g. CAT 320" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Type</label>
                    <select className="w-full p-3 border rounded-lg bg-white"
                      value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                      <option>Excavator</option><option>Bulldozer</option><option>Crane</option>
                      <option>Loader</option><option>Lift</option><option>Skid Steer</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Base Daily Rate ($)</label>
                    <input required type="number" className="w-full p-3 border rounded-lg"
                      value={form.baseRate} onChange={e => setForm({...form, baseRate: e.target.value})} />
                  </div>
                </div>

                <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                  <label className="flex items-center gap-2 font-medium text-slate-700 mb-3 cursor-pointer select-none">
                    <input type="checkbox" checked={form.hasLoan} onChange={e => setForm({...form, hasLoan: e.target.checked})} 
                      className="w-5 h-5 text-blue-600 rounded" />
                    Active Loan / Financing
                  </label>
                  {form.hasLoan && (
                    <div className="grid grid-cols-2 gap-4 animate-fadeIn">
                      <div>
                        <label className="block text-xs uppercase font-bold text-slate-400 mb-1">Monthly Pmt</label>
                        <input required type="number" className="w-full p-3 border rounded bg-white" placeholder="0.00"
                          value={form.loanPayment} onChange={e => setForm({...form, loanPayment: e.target.value})} />
                      </div>
                      <div>
                        <label className="block text-xs uppercase font-bold text-slate-400 mb-1">Interest %</label>
                        <input required type="number" step="0.1" className="w-full p-3 border rounded bg-white" placeholder="0.0"
                          value={form.loanInterest} onChange={e => setForm({...form, loanInterest: e.target.value})} />
                      </div>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Next Maintenance</label>
                    <input required type="date" className="w-full p-3 border rounded-lg bg-white"
                      value={form.maintNext} onChange={e => setForm({...form, maintNext: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Frequency</label>
                    <select className="w-full p-3 border rounded-lg bg-white"
                      value={form.maintFreq} onChange={e => setForm({...form, maintFreq: e.target.value})}>
                      <option>Weekly</option><option>Monthly</option><option>Quarterly</option><option>Annually</option>
                    </select>
                  </div>
                </div>

                <div className="flex gap-3 pt-4">
                  <button type="button" onClick={onCancel} className="flex-1 p-3 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium">Cancel</button>
                  <button type="submit" className="flex-1 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-sm">Save Machine</button>
                </div>
              </form>
            </div>
          );
        };

        // 2. Rent Out Screen
        const RentMachine = ({ machines, onRent, onCancel }) => {
          const [form, setForm] = useState({
            machineId: machines[0]?.id || '',
            customer: '', startDate: '', endDate: '', rate: machines[0]?.baseRate || ''
          });

          const handleMachineChange = (id) => {
            const m = machines.find(x => x.id === id);
            setForm({ ...form, machineId: id, rate: m ? m.baseRate : '' });
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            onRent({
              machineId: form.machineId, type: 'rental', customer: form.customer,
              startDate: form.startDate, endDate: form.endDate, rate: Number(form.rate)
            });
          };

          return (
            <div className="max-w-2xl mx-auto bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-lg md:text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <DollarSign className="w-6 h-6 text-green-600" /> New Rental Agreement
              </h2>
              <form onSubmit={handleSubmit} className="space-y-4 md:space-y-6">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Select Equipment</label>
                  <select required className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white transition-colors"
                    value={form.machineId} onChange={e => handleMachineChange(e.target.value)}>
                    {machines.map(m => (
                      <option key={m.id} value={m.id}>{m.name}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Customer / Project</label>
                  <input required type="text" className="w-full p-3 border rounded-lg"
                    value={form.customer} onChange={e => setForm({...form, customer: e.target.value})} placeholder="e.g. Downtown Construction" />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Start Date</label>
                    <input required type="date" className="w-full p-3 border rounded-lg bg-white"
                      value={form.startDate} onChange={e => setForm({...form, startDate: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">End Date</label>
                    <input required type="date" className="w-full p-3 border rounded-lg bg-white"
                      value={form.endDate} onChange={e => setForm({...form, endDate: e.target.value})} />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Daily Rate ($)</label>
                  <input required type="number" className="w-full p-3 border rounded-lg font-mono text-slate-700"
                    value={form.rate} onChange={e => setForm({...form, rate: e.target.value})} />
                </div>
                <div className="flex gap-3 pt-4">
                  <button type="button" onClick={onCancel} className="flex-1 p-3 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium">Cancel</button>
                  <button type="submit" className="flex-1 p-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-sm">Confirm</button>
                </div>
              </form>
            </div>
          );
        };

        // 3. Maintenance Tracker
        const MaintenanceTracker = ({ machines, maintenanceEvents, onSchedule }) => {
          const [scheduleForm, setScheduleForm] = useState({
            machineId: machines[0]?.id || '', date: '', description: '', cost: ''
          });
          const [completingId, setCompletingId] = useState(null);
          const [completionData, setCompletionData] = useState({ date: '', cost: '', description: 'Routine Maintenance' });

          const today = useMemo(() => new Date().toISOString().split('T')[0], []);

          const handleScheduleSubmit = (e) => {
            e.preventDefault();
            if(!scheduleForm.machineId || !scheduleForm.date) return;
            onSchedule({
                ...scheduleForm, actionType: 'schedule', cost: Number(scheduleForm.cost)
            });
            setScheduleForm(prev => ({ ...prev, description: '', cost: '' }));
          };

          const submitCompletion = (machineId) => {
             onSchedule({
                 machineId, date: completionData.date, description: completionData.description,
                 cost: Number(completionData.cost), actionType: 'complete'
             });
             setCompletingId(null);
          };

          const getStatusColor = (nextDate) => {
            if (!nextDate) return 'bg-slate-100 text-slate-500';
            if (nextDate < today) return 'bg-red-100 text-red-700 border-red-200';
            const daysUntil = (new Date(nextDate) - new Date(today)) / (1000 * 60 * 60 * 24);
            if (daysUntil <= 7) return 'bg-amber-100 text-amber-700 border-amber-200';
            return 'bg-green-100 text-green-700 border-green-200';
          };

          return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fadeIn items-start pb-20">
              
              {/* Schedule Form */}
              <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-2">
                  <CalendarIcon className="w-5 h-5 text-blue-600" /> Schedule Future
                </h2>
                <form onSubmit={handleScheduleSubmit} className="space-y-4">
                  <select className="w-full p-3 border rounded-lg bg-slate-50 text-sm"
                    value={scheduleForm.machineId} onChange={e => setScheduleForm({...scheduleForm, machineId: e.target.value})}>
                    {machines.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                  </select>
                  <input required type="date" className="w-full p-3 border rounded-lg text-sm bg-white"
                    value={scheduleForm.date} onChange={e => setScheduleForm({...scheduleForm, date: e.target.value})} />
                  <input required type="text" className="w-full p-3 border rounded-lg text-sm" placeholder="Task e.g. 500hr Service"
                    value={scheduleForm.description} onChange={e => setScheduleForm({...scheduleForm, description: e.target.value})} />
                  <input type="number" className="w-full p-3 border rounded-lg text-sm" placeholder="Est. Cost ($)"
                    value={scheduleForm.cost} onChange={e => setScheduleForm({...scheduleForm, cost: e.target.value})} />
                  <button type="submit" className="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                    <Plus size={16}/> Add to Schedule
                  </button>
                </form>
              </div>

              {/* Upcoming List */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full lg:max-h-[600px]">
                <div className="p-4 border-b border-slate-100 bg-slate-50">
                  <h3 className="font-bold text-slate-700 flex items-center gap-2">
                    <Clock className="w-4 h-4 text-amber-600" /> Upcoming / Due
                  </h3>
                </div>
                <div className="divide-y divide-slate-100 overflow-y-auto">
                  {machines.sort((a,b) => (a.maintenance?.nextDate || '9999').localeCompare(b.maintenance?.nextDate || '9999'))
                   .map(m => {
                    const statusClass = getStatusColor(m.maintenance.nextDate);
                    const isOverdue = m.maintenance.nextDate < today;
                    return (
                      <div key={m.id} className={`p-4 ${completingId === m.id ? 'bg-green-50' : 'bg-white'}`}>
                        {completingId !== m.id ? (
                            <div className="flex flex-col gap-3">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h4 className="font-bold text-sm text-slate-800">{m.name}</h4>
                                        <p className="text-xs text-slate-500">{m.type} â€¢ {m.maintenance.frequency}</p>
                                    </div>
                                    <div className={`px-2 py-1 rounded text-[10px] font-bold border uppercase tracking-wide ${statusClass}`}>
                                        {isOverdue ? 'Overdue' : 'Due'}: {formatDate(m.maintenance.nextDate)}
                                    </div>
                                </div>
                                <button onClick={() => { setCompletingId(m.id); setCompletionData({...completionData, date: today}); }}
                                    className="w-full py-2 bg-white border border-green-200 text-green-700 text-xs font-bold rounded hover:bg-green-50 flex items-center justify-center gap-2">
                                    <CheckSquare size={14} /> Mark Complete
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-3 animate-fadeIn">
                                <div className="flex justify-between items-center mb-1">
                                    <h4 className="font-bold text-sm text-green-800">Complete Task</h4>
                                    <button onClick={() => setCompletingId(null)}><X size={16} className="text-slate-400"/></button>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" className="w-full p-2 border rounded text-xs bg-white" value={completionData.date} 
                                        onChange={e => setCompletionData({...completionData, date: e.target.value})} />
                                    <input type="number" className="w-full p-2 border rounded text-xs" placeholder="Cost ($)" value={completionData.cost} 
                                        onChange={e => setCompletionData({...completionData, cost: e.target.value})} />
                                </div>
                                <input type="text" className="w-full p-2 border rounded text-xs" placeholder="Notes" value={completionData.description} 
                                    onChange={e => setCompletionData({...completionData, description: e.target.value})} />
                                <button onClick={() => submitCompletion(m.id)} className="w-full py-2 bg-green-600 text-white text-xs font-bold rounded">
                                    Confirm & Update
                                </button>
                            </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* History List */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden lg:max-h-[600px] flex flex-col">
                <div className="p-4 border-b border-slate-100 bg-slate-50">
                  <h3 className="font-bold text-slate-700 flex items-center gap-2">
                    <History className="w-4 h-4 text-slate-500" /> Recent History
                  </h3>
                </div>
                <div className="divide-y divide-slate-100 overflow-y-auto">
                    {maintenanceEvents.filter(e => e.status === 'complete').sort((a,b) => new Date(b.date) - new Date(a.date)).map((ev, idx) => {
                        const m = machines.find(x => x.id === ev.machineId);
                        return (
                            <div key={idx} className="p-4 flex justify-between items-start">
                                <div>
                                    <div className="font-medium text-sm text-slate-800">{m?.name || 'Unknown'}</div>
                                    <div className="text-xs text-slate-500">{ev.description}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded">{formatDate(ev.date)}</div>
                                    {ev.cost > 0 && <div className="text-xs text-slate-400 font-mono mt-1">${ev.cost}</div>}
                                </div>
                            </div>
                        )
                    })}
                    {maintenanceEvents.filter(e => e.status === 'complete').length === 0 && <div className="p-6 text-center text-slate-400 text-sm">No history yet</div>}
                </div>
              </div>

            </div>
          );
        };

        // 4. Calendar View (Responsive)
        const CalendarView = ({ machines, transactions, maintenanceEvents }) => {
          const [currentDate, setCurrentDate] = useState(new Date());
          const [selectedDate, setSelectedDate] = useState(new Date());

          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const daysInMonth = getDaysInMonth(year, month);
          const startDay = getFirstDayOfMonth(year, month);
          const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
          const emptyDays = Array.from({ length: startDay }, (_, i) => i);

          const allEvents = useMemo(() => {
              const rentals = transactions.filter(t => t.type === 'rental');
              const maint = maintenanceEvents.map(m => ({ ...m, type: 'maintenance', startDate: m.date, endDate: m.date }));
              return [...rentals, ...maint];
          }, [transactions, maintenanceEvents]);

          const getEventsForDay = (day) => {
            const dateStr = new Date(year, month, day).toISOString().split('T')[0];
            return allEvents.filter(t => t.startDate <= dateStr && t.endDate >= dateStr);
          };

          const handleDayClick = (day) => {
              setSelectedDate(new Date(year, month, day));
          };

          // Selected day events for Mobile view detail
          const selectedDayEvents = useMemo(() => {
              const dateStr = selectedDate.toISOString().split('T')[0];
              return allEvents.filter(t => t.startDate <= dateStr && t.endDate >= dateStr);
          }, [selectedDate, allEvents]);

          return (
            <div className="space-y-4 pb-20">
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                  <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="p-2 hover:bg-slate-200 rounded-full"><ChevronLeft className="w-5 h-5"/></button>
                  <h2 className="text-lg font-bold text-slate-800">{currentDate.toLocaleDateString('default', { month: 'long', year: 'numeric' })}</h2>
                  <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="p-2 hover:bg-slate-200 rounded-full"><ChevronRight className="w-5 h-5"/></button>
                </div>
                
                <div className="grid grid-cols-7 text-center border-b border-slate-100 bg-slate-50 text-[10px] md:text-xs font-semibold text-slate-400 py-2">
                  <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div className="grid grid-cols-7 bg-slate-100 gap-px">
                  {emptyDays.map(d => <div key={`e-${d}`} className="bg-white min-h-[60px] md:min-h-[100px]" />)}
                  {daysArray.map(day => {
                    const events = getEventsForDay(day);
                    const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                    const isSelected = selectedDate.toDateString() === new Date(year, month, day).toDateString();
                    
                    return (
                      <div key={day} onClick={() => handleDayClick(day)}
                        className={`bg-white min-h-[60px] md:min-h-[100px] p-1 md:p-2 cursor-pointer transition-colors ${isSelected ? 'bg-blue-50 ring-2 ring-inset ring-blue-200' : ''}`}>
                        <div className={`text-xs md:text-sm font-medium mb-1 flex justify-center md:justify-start ${isToday ? 'text-blue-600 font-bold' : 'text-slate-700'}`}>
                            <span className={`${isToday ? 'bg-blue-100 px-1.5 rounded-full' : ''}`}>{day}</span>
                        </div>
                        
                        {/* Mobile Dots */}
                        <div className="flex md:hidden justify-center gap-1 flex-wrap">
                            {events.slice(0, 4).map((e, i) => (
                                <div key={i} className={`w-1.5 h-1.5 rounded-full ${e.type === 'maintenance' ? 'bg-amber-400' : 'bg-blue-400'}`} />
                            ))}
                            {events.length > 4 && <div className="w-1.5 h-1.5 rounded-full bg-slate-300" />}
                        </div>

                        {/* Desktop List */}
                        <div className="hidden md:flex flex-col gap-1">
                           {events.map((ev, idx) => {
                               const m = machines.find(x => x.id === ev.machineId);
                               const isMaint = ev.type === 'maintenance';
                               return (
                                   <div key={idx} className={`text-[10px] px-1 rounded truncate border ${isMaint ? 'bg-amber-50 border-amber-100 text-amber-700' : 'bg-blue-50 border-blue-100 text-blue-700'}`}>
                                       {m?.name.split(' ')[0]}
                                   </div>
                               )
                           })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Day Details (Mobile Friendly) */}
              <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <h3 className="font-bold text-slate-800 border-b pb-2 mb-3">
                      Events for {selectedDate.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric'})}
                  </h3>
                  <div className="space-y-2">
                      {selectedDayEvents.length === 0 ? (
                          <p className="text-sm text-slate-400 italic">No events scheduled.</p>
                      ) : (
                          selectedDayEvents.map((ev, i) => {
                              const m = machines.find(x => x.id === ev.machineId);
                              const isMaint = ev.type === 'maintenance';
                              return (
                                  <div key={i} className={`p-3 rounded-lg border flex justify-between items-center ${isMaint ? 'bg-amber-50 border-amber-200' : 'bg-blue-50 border-blue-200'}`}>
                                      <div>
                                          <div className="font-bold text-sm text-slate-800">{m?.name}</div>
                                          <div className="text-xs text-slate-600">{isMaint ? ev.description : `Rent: ${ev.customer}`}</div>
                                      </div>
                                      <div className={`text-xs font-bold px-2 py-1 rounded uppercase ${isMaint ? 'bg-amber-200 text-amber-800' : 'bg-blue-200 text-blue-800'}`}>
                                          {isMaint ? 'Maint' : 'Rent'}
                                      </div>
                                  </div>
                              )
                          })
                      )}
                  </div>
              </div>
            </div>
          );
        };

        // 5. Performance View
        const PerformanceView = ({ machines, transactions, maintenanceEvents }) => {
            // ... (Logic remains same, updating display for mobile)
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const monthStart = new Date(currentYear, currentMonth, 1);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);

            const metrics = useMemo(() => {
                return machines.map(m => {
                    let bookedDays = 0, rentalIncome = 0, maintenanceCost = 0;
                    const machineRentals = transactions.filter(t => t.machineId === m.id && t.type === 'rental');
                    machineRentals.forEach(t => {
                        const tStart = new Date(t.startDate);
                        const tEnd = new Date(t.endDate);
                        const startOverlap = tStart < monthStart ? monthStart : tStart;
                        const endOverlap = tEnd > monthEnd ? monthEnd : tEnd;
                        if (startOverlap <= endOverlap) {
                            const days = (endOverlap - startOverlap) / (1000 * 60 * 60 * 24) + 1;
                            bookedDays += days;
                            rentalIncome += (days * t.rate);
                        }
                    });
                    const machineMaint = maintenanceEvents.filter(me => me.machineId === m.id);
                    machineMaint.forEach(me => {
                        const meDate = new Date(me.date);
                        if (meDate >= monthStart && meDate <= monthEnd) maintenanceCost += (me.cost || 0);
                    });
                    const totalExpenses = (m.loan.active ? m.loan.payment : 0) + maintenanceCost;
                    return { ...m, bookedDays, rentalIncome, totalExpenses, netProfit: rentalIncome - totalExpenses };
                });
            }, [machines, transactions, maintenanceEvents]);

            const totals = metrics.reduce((acc, curr) => ({
                revenue: acc.revenue + curr.rentalIncome,
                expenses: acc.expenses + curr.totalExpenses,
                profit: acc.profit + curr.netProfit
            }), { revenue: 0, expenses: 0, profit: 0 });

            return (
                <div className="space-y-4 pb-20">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <p className="text-xs font-bold uppercase text-slate-500">Revenue</p>
                                <h3 className="text-2xl font-bold text-slate-800">${totals.revenue.toLocaleString()}</h3>
                            </div>
                            <div className="bg-green-100 p-2 rounded-lg text-green-600"><TrendingUp size={24}/></div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <p className="text-xs font-bold uppercase text-slate-500">Expenses</p>
                                <h3 className="text-2xl font-bold text-slate-800">${totals.expenses.toLocaleString()}</h3>
                            </div>
                            <div className="bg-red-100 p-2 rounded-lg text-red-600"><TrendingDown size={24}/></div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <p className="text-xs font-bold uppercase text-slate-500">Net Profit</p>
                                <h3 className={`text-2xl font-bold ${totals.profit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {totals.profit >= 0 ? '+' : ''}${totals.profit.toLocaleString()}
                                </h3>
                            </div>
                            <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><BarChart3 size={24}/></div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-4 bg-slate-50 border-b border-slate-100"><h3 className="font-bold text-slate-700">Monthly Breakdown</h3></div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left whitespace-nowrap">
                                <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                    <tr>
                                        <th className="p-4">Machine</th>
                                        <th className="p-4">Util</th>
                                        <th className="p-4 text-right">Rev</th>
                                        <th className="p-4 text-right">Exp</th>
                                        <th className="p-4 text-right">Net</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {metrics.map(m => (
                                        <tr key={m.id}>
                                            <td className="p-4 font-medium text-slate-800">{m.name}</td>
                                            <td className="p-4">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold">{Math.round(m.bookedDays)}d</span>
                                                    <div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                                        <div className="h-full bg-blue-500" style={{ width: `${(m.bookedDays / daysInMonth) * 100}%` }} />
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-4 text-right text-green-600 font-mono">${m.rentalIncome.toLocaleString()}</td>
                                            <td className="p-4 text-right text-red-500 font-mono">${m.totalExpenses.toLocaleString()}</td>
                                            <td className={`p-4 text-right font-bold font-mono ${m.netProfit>=0?'text-slate-800':'text-red-600'}`}>${m.netProfit.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )
        };

        // --- Main App Component ---
        const App = () => {
          const [user, setUser] = useState(null);
          const [view, setView] = useState('calendar'); 
          const [machines, setMachines] = useState([]);
          const [transactions, setTransactions] = useState([]);
          const [maintenanceEvents, setMaintenanceEvents] = useState([]);
          const [authError, setAuthError] = useState(null);
          const [permissionError, setPermissionError] = useState(false);
          const [isSeeding, setIsSeeding] = useState(false);
          const [editingId, setEditingId] = useState(null);
          const [editValues, setEditValues] = useState({ rate: '', payment: '', interest: '' });

          useEffect(() => {
            const initAuth = async () => {
              try { await signInAnonymously(auth); } catch (e) { setAuthError(e.message); }
            };
            initAuth();
            return onAuthStateChanged(auth, (u) => setUser(u));
          }, []);

          useEffect(() => {
            if (!user) return;
            const handlePermissionError = (err) => { if (err.code === 'permission-denied') setPermissionError(true); };
            
            const unsubMachines = onSnapshot(collection(db, 'machines'), (s) => setMachines(s.docs.map(d => ({...d.data(), id: d.id}))), handlePermissionError);
            const unsubTrans = onSnapshot(collection(db, 'transactions'), (s) => setTransactions(s.docs.map(d => ({...d.data(), id: d.id}))), handlePermissionError);
            const unsubMaint = onSnapshot(collection(db, 'maintenance'), (s) => setMaintenanceEvents(s.docs.map(d => ({...d.data(), id: d.id}))), handlePermissionError);

            return () => { unsubMachines(); unsubTrans(); unsubMaint(); };
          }, [user]);

          const handleSeedData = async () => {
            if (!user || isSeeding) return;
            setIsSeeding(true);
            try {
                const batch = writeBatch(db);
                SEED_MACHINES.forEach(m => batch.set(doc(db, 'machines', m.id), m));
                SEED_TRANSACTIONS.forEach(t => batch.set(doc(collection(db, 'transactions')), t));
                SEED_MAINTENANCE.forEach(m => batch.set(doc(collection(db, 'maintenance')), m));
                await batch.commit();
            } catch (err) { if (err.code === 'permission-denied') setPermissionError(true); else alert(err.message); } 
            finally { setIsSeeding(false); }
          };

          const handleAddMachine = async (data) => {
             if(user) { await addDoc(collection(db, 'machines'), data); setView('list'); }
          };
          const handleRent = async (data) => {
             if(user) { await addDoc(collection(db, 'transactions'), data); setView('calendar'); }
          };
          const handleSchedule = async ({ machineId, date, description, cost, actionType }) => {
             if (!user) return;
             await addDoc(collection(db, 'maintenance'), { machineId, description, date, cost, status: actionType, ...(actionType === 'complete' && { completedAt: new Date().toISOString() }) });
             const machine = machines.find(m => m.id === machineId);
             if (machine) {
                let nextDt = new Date(date);
                if (actionType === 'complete') {
                    if (machine.maintenance.frequency === 'Weekly') nextDt.setDate(nextDt.getDate() + 7);
                    else if (machine.maintenance.frequency === 'Monthly') nextDt.setMonth(nextDt.getMonth() + 1);
                    else if (machine.maintenance.frequency === 'Quarterly') nextDt.setMonth(nextDt.getMonth() + 3);
                    else if (machine.maintenance.frequency === 'Annually') nextDt.setFullYear(nextDt.getFullYear() + 1);
                }
                await updateDoc(doc(db, 'machines', machineId), { 'maintenance.nextDate': nextDt.toISOString().split('T')[0] });
             }
          };

          const saveEdit = async (id) => {
             if(!user) return;
             await updateDoc(doc(db, 'machines', id), {
                baseRate: Number(editValues.rate), 'loan.payment': Number(editValues.payment),
                'loan.interest': Number(editValues.interest), 'loan.active': Number(editValues.payment) > 0
             });
             setEditingId(null);
          };

          if (permissionError) return (
             <div className="flex h-screen items-center justify-center p-6 bg-red-50 text-red-900">
                <div className="max-w-md bg-white p-6 rounded-xl shadow-xl border border-red-200 text-center">
                    <Lock className="w-10 h-10 text-red-600 mx-auto mb-4"/>
                    <h2 className="text-xl font-bold mb-2">Database Access Blocked</h2>
                    <p className="text-sm mb-4">You need to enable read/write access in your Firestore Rules console.</p>
                    <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold">Retry</button>
                </div>
             </div>
          );

          if (!user) return <div className="flex h-screen items-center justify-center text-slate-400 animate-pulse">Loading App...</div>;

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-safe">
              {/* Desktop Top Nav */}
              <nav className="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md hidden md:block">
                <div className="max-w-6xl mx-auto flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <div className="bg-yellow-500 p-2 rounded-lg text-slate-900 font-bold">EQ</div>
                    <h1 className="text-xl font-bold">EquipTrack Pro</h1>
                  </div>
                  <div className="flex gap-2">
                    {['calendar', 'list', 'performance', 'maintenance', 'rent', 'add'].map(v => (
                        <button key={v} onClick={() => setView(v)} className={`px-3 py-1.5 rounded text-sm font-medium capitalize ${view === v ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white'}`}>
                            {v === 'list' ? 'Fleet' : v}
                        </button>
                    ))}
                  </div>
                </div>
              </nav>

              {/* Mobile Top Header */}
              <div className="md:hidden bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
                   <div className="flex items-center gap-2">
                    <div className="bg-yellow-500 p-1.5 rounded text-slate-900 font-bold text-xs">EQ</div>
                    <h1 className="text-lg font-bold">EquipTrack</h1>
                  </div>
                  <button onClick={() => setView('add')} className="p-2 bg-blue-600 rounded-full text-white"><Plus size={18}/></button>
              </div>

              {/* Main Content */}
              <main className="max-w-6xl mx-auto p-4 md:p-6 mb-16 md:mb-0">
                {/* Stats Header */}
                {(view === 'calendar' || view === 'list') && (
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div className="bg-white p-3 rounded-xl border shadow-sm flex items-center gap-3">
                            <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Truck size={16}/></div>
                            <div><p className="text-[10px] uppercase font-bold text-slate-500">Fleet</p><p className="text-lg font-bold">{machines.length}</p></div>
                        </div>
                        <div className="bg-white p-3 rounded-xl border shadow-sm flex items-center gap-3">
                            <div className="bg-green-100 p-2 rounded-full text-green-600"><CheckCircle size={16}/></div>
                            <div><p className="text-[10px] uppercase font-bold text-slate-500">Active</p><p className="text-lg font-bold">{transactions.filter(t => t.type==='rental' && t.endDate >= new Date().toISOString().split('T')[0]).length}</p></div>
                        </div>
                    </div>
                )}

                {view === 'add' && <AddMachine onAdd={handleAddMachine} onCancel={() => setView('calendar')} />}
                {view === 'rent' && <RentMachine machines={machines} onRent={handleRent} onCancel={() => setView('calendar')} />}
                {view === 'maintenance' && <MaintenanceTracker machines={machines} maintenanceEvents={maintenanceEvents} onSchedule={handleSchedule} />}
                {view === 'performance' && <PerformanceView machines={machines} transactions={transactions} maintenanceEvents={maintenanceEvents} />}
                {view === 'calendar' && <CalendarView machines={machines} transactions={transactions} maintenanceEvents={maintenanceEvents} />}
                
                {view === 'list' && (
                    <div className="space-y-4 pb-20">
                        {machines.map(m => (
                            <div key={m.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="font-bold text-slate-800">{m.name}</h3>
                                    <button onClick={() => { setEditingId(m.id); setEditValues({ rate: m.baseRate, payment: m.loan?.payment||0, interest: m.loan?.interest||0 }); }} className="text-slate-400 p-1"><Pencil size={16}/></button>
                                </div>
                                <div className="flex gap-2 text-xs mb-3">
                                    <span className="bg-slate-100 px-2 py-1 rounded text-slate-600">{m.type}</span>
                                    <span className="bg-green-100 text-green-700 px-2 py-1 rounded font-mono">${m.baseRate}/day</span>
                                </div>
                                {editingId === m.id ? (
                                    <div className="bg-slate-50 p-3 rounded-lg space-y-3">
                                        <div className="grid grid-cols-2 gap-2">
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase">Rate</label><input type="number" className="w-full p-1 border rounded" value={editValues.rate} onChange={e=>setEditValues({...editValues, rate: e.target.value})}/></div>
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase">Loan Pmt</label><input type="number" className="w-full p-1 border rounded" value={editValues.payment} onChange={e=>setEditValues({...editValues, payment: e.target.value})}/></div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>saveEdit(m.id)} className="flex-1 bg-green-600 text-white py-1 rounded text-xs font-bold">Save</button>
                                            <button onClick={()=>setEditingId(null)} className="flex-1 bg-slate-200 text-slate-600 py-1 rounded text-xs font-bold">Cancel</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-xs text-slate-500 flex items-center gap-1"><Clock size={12}/> Next Service: {formatDate(m.maintenance.nextDate)}</div>
                                )}
                            </div>
                        ))}
                        {machines.length === 0 && <button onClick={handleSeedData} disabled={isSeeding} className="w-full py-4 border-2 border-dashed rounded-xl text-slate-400 text-sm font-medium">{isSeeding ? 'Loading...' : 'Load Sample Data'}</button>}
                    </div>
                )}
              </main>

              {/* Mobile Bottom Nav */}
              <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center p-2 z-50 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                  <button onClick={() => setView('calendar')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view === 'calendar' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}>
                      <CalendarIcon size={20} />
                      <span className="text-[10px] font-medium mt-1">Calendar</span>
                  </button>
                  <button onClick={() => setView('list')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view === 'list' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}>
                      <List size={20} />
                      <span className="text-[10px] font-medium mt-1">Fleet</span>
                  </button>
                  <button onClick={() => setView('rent')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view === 'rent' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}>
                      <DollarSign size={20} />
                      <span className="text-[10px] font-medium mt-1">Rent</span>
                  </button>
                  <button onClick={() => setView('maintenance')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view === 'maintenance' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}>
                      <Wrench size={20} />
                      <span className="text-[10px] font-medium mt-1">Maint</span>
                  </button>
                  <button onClick={() => setView('performance')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view === 'performance' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}>
                      <BarChart3 size={20} />
                      <span className="text-[10px] font-medium mt-1">Stats</span>
                  </button>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>