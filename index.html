<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Calendar as CalendarIcon, Truck, DollarSign, Wrench, ChevronLeft, ChevronRight, Search, CheckCircle, AlertCircle, AlertTriangle, Clock, Pencil, Save, X, Database, BarChart3, TrendingUp, TrendingDown, Lock, CheckSquare, History } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from "firebase/app";
        import { 
          getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, 
          query, getDocs, writeBatch, setDoc 
        } from "firebase/firestore";
        import { 
          getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from "firebase/auth";

        // --- Configuration ---
        // Explicitly using the configuration provided by the user
        const firebaseConfig = {
          apiKey: "AIzaSyATXRPfV9NgttQ3ompCk-xeVOqvm6uIU6s",
          authDomain: "equipmenttracker-857f8.firebaseapp.com",
          projectId: "equipmenttracker-857f8",
          storageBucket: "equipmenttracker-857f8.firebasestorage.app",
          messagingSenderId: "1088031272040",
          appId: "1:1088031272040:web:44cd3b106b66f2535a5fdd"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Use a consistent ID for the path
        const appId = 'equipment-tracker-default';

        // --- Mock Data for Seeding ---
        const SEED_MACHINES = [
          { 
            id: "1", 
            name: 'CAT 329E L Excavator', 
            type: 'Excavator', 
            loan: { active: true, payment: 2500, interest: 5.5 }, 
            maintenance: { nextDate: '2025-12-15', frequency: 'Monthly' },
            baseRate: 1000 
          },
          { 
            id: "2", 
            name: 'Bobcat T66 Compact Track Loader (Cab/AC)', 
            type: 'Track Loader', 
            loan: { active: true, payment: 900, interest: 4.2 }, 
            maintenance: { nextDate: '2026-03-01', frequency: 'Quarterly' },
            baseRate: 300 
          },
          { 
            id: "3", 
            name: 'Bobcat T66 Compact Track Loader', 
            type: 'Track Loader', 
            loan: { active: true, payment: 800, interest: 4.0 }, 
            maintenance: { nextDate: '2026-02-20', frequency: 'Monthly' },
            baseRate: 250 
          },
          { 
            id: "4", 
            name: 'CAT 259D3 Compact Track Loader', 
            type: 'Track Loader', 
            loan: { active: false, payment: 0, interest: 0 }, 
            maintenance: { nextDate: '2026-03-10', frequency: 'Monthly' },
            baseRate: 300 
          },
          { 
            id: "5", 
            name: 'Toro Dingo TX 427 Mini Track Loader', 
            type: 'Mini Loader', 
            loan: { active: false, payment: 0, interest: 0 }, 
            maintenance: { nextDate: '2026-04-15', frequency: 'Annually' },
            baseRate: 200 
          },
          { 
            id: "6", 
            name: 'CAT 236D Skidsteer', 
            type: 'Skid Steer', 
            loan: { active: true, payment: 650, interest: 3.8 }, 
            maintenance: { nextDate: '2026-02-28', frequency: 'Quarterly' },
            baseRate: 250 
          },
          { 
            id: "7", 
            name: 'John Deere 317G Compact Track Loader', 
            type: 'Track Loader', 
            loan: { active: true, payment: 750, interest: 3.9 }, 
            maintenance: { nextDate: '2026-03-05', frequency: 'Monthly' },
            baseRate: 250 
          },
          { 
            id: "8", 
            name: 'Terex T16 Mini Excavator', 
            type: 'Mini Excavator', 
            loan: { active: false, payment: 0, interest: 0 }, 
            maintenance: { nextDate: '2026-03-20', frequency: 'Quarterly' },
            baseRate: 200 
          }
        ];

        const SEED_TRANSACTIONS = [
          { machineId: "1", type: 'rental', customer: 'Heavy Duty Construction', startDate: '2026-02-01', endDate: '2026-02-15', rate: 1000 },
          { machineId: "2", type: 'rental', customer: 'Local Landscapers', startDate: '2026-02-10', endDate: '2026-02-12', rate: 300 },
          { machineId: "5", type: 'rental', customer: 'Backyard Renos', startDate: '2026-02-20', endDate: '2026-02-22', rate: 200 },
        ];

        const SEED_MAINTENANCE = [
          { machineId: "1", description: 'Hydraulic System Check', cost: 450, status: 'complete', date: '2026-01-15', completedAt: '2026-01-15T10:00:00Z' },
          { machineId: "3", description: 'Oil Change', cost: 120, status: 'complete', date: '2026-01-20', completedAt: '2026-01-20T14:30:00Z' }
        ];

        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const formatDate = (dateString) => {
          if (!dateString) return '';
          const options = { month: 'short', day: 'numeric', year: 'numeric' };
          return new Date(dateString).toLocaleDateString(undefined, options);
        };

        // --- Components ---

        // 1. Add Machine Screen
        const AddMachine = ({ onAdd, onCancel }) => {
          const [form, setForm] = useState({
            name: '', type: 'Excavator', baseRate: '', 
            hasLoan: false, loanPayment: '', loanInterest: '',
            maintNext: '', maintFreq: 'Monthly'
          });

          const handleSubmit = (e) => {
            e.preventDefault();
            onAdd({
              name: form.name,
              type: form.type,
              baseRate: Number(form.baseRate),
              loan: { 
                active: form.hasLoan, 
                payment: form.hasLoan ? Number(form.loanPayment) : 0, 
                interest: form.hasLoan ? Number(form.loanInterest) : 0 
              },
              maintenance: {
                nextDate: form.maintNext,
                frequency: form.maintFreq
              }
            });
          };

          return (
            <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <Truck className="w-6 h-6 text-blue-600" /> Add New Equipment
              </h2>
              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Machine Name</label>
                    <input required type="text" className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                      value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="e.g. CAT 320" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Type</label>
                    <select className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                      <option>Excavator</option>
                      <option>Bulldozer</option>
                      <option>Crane</option>
                      <option>Loader</option>
                      <option>Lift</option>
                      <option>Skid Steer</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Base Daily Rate ($)</label>
                    <input required type="number" className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                      value={form.baseRate} onChange={e => setForm({...form, baseRate: e.target.value})} />
                  </div>
                </div>

                <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                  <label className="flex items-center gap-2 font-medium text-slate-700 mb-3 cursor-pointer">
                    <input type="checkbox" checked={form.hasLoan} onChange={e => setForm({...form, hasLoan: e.target.checked})} 
                      className="w-4 h-4 text-blue-600 rounded" />
                    Active Loan / Financing
                  </label>
                  {form.hasLoan && (
                    <div className="grid grid-cols-2 gap-4 animate-fadeIn">
                      <div>
                        <label className="block text-xs uppercase font-bold text-slate-400 mb-1">Monthly Payment</label>
                        <input required type="number" className="w-full p-2 border rounded bg-white" placeholder="0.00"
                          value={form.loanPayment} onChange={e => setForm({...form, loanPayment: e.target.value})} />
                      </div>
                      <div>
                        <label className="block text-xs uppercase font-bold text-slate-400 mb-1">Interest Rate (%)</label>
                        <input required type="number" step="0.1" className="w-full p-2 border rounded bg-white" placeholder="0.0"
                          value={form.loanInterest} onChange={e => setForm({...form, loanInterest: e.target.value})} />
                      </div>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Next Maintenance</label>
                    <input required type="date" className="w-full p-2 border rounded-lg"
                      value={form.maintNext} onChange={e => setForm({...form, maintNext: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Frequency</label>
                    <select className="w-full p-2 border rounded-lg"
                      value={form.maintFreq} onChange={e => setForm({...form, maintFreq: e.target.value})}>
                      <option>Weekly</option>
                      <option>Monthly</option>
                      <option>Quarterly</option>
                      <option>Annually</option>
                    </select>
                  </div>
                </div>

                <div className="flex gap-3 pt-4">
                  <button type="button" onClick={onCancel} className="flex-1 p-3 text-slate-600 hover:bg-slate-50 rounded-lg font-medium">Cancel</button>
                  <button type="submit" className="flex-1 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-sm">Save Machine</button>
                </div>
              </form>
            </div>
          );
        };

        // 2. Rent Out Screen
        const RentMachine = ({ machines, onRent, onCancel }) => {
          const [form, setForm] = useState({
            machineId: machines[0]?.id || '',
            customer: '',
            startDate: '',
            endDate: '',
            rate: machines[0]?.baseRate || ''
          });

          // Update rate when machine changes
          const handleMachineChange = (id) => {
            const m = machines.find(x => x.id === id);
            setForm({ ...form, machineId: id, rate: m ? m.baseRate : '' });
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            onRent({
              machineId: form.machineId,
              type: 'rental',
              customer: form.customer,
              startDate: form.startDate,
              endDate: form.endDate,
              rate: Number(form.rate)
            });
          };

          return (
            <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <DollarSign className="w-6 h-6 text-green-600" /> New Rental Agreement
              </h2>
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Select Equipment</label>
                  <select required className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white transition-colors"
                    value={form.machineId} onChange={e => handleMachineChange(e.target.value)}>
                    {machines.map(m => (
                      <option key={m.id} value={m.id}>{m.name} ({m.type}) - Base: ${m.baseRate}/day</option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Customer / Project Name</label>
                  <input required type="text" className="w-full p-2 border rounded-lg"
                    value={form.customer} onChange={e => setForm({...form, customer: e.target.value})} placeholder="e.g. Downtown Construction LLC" />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">Start Date</label>
                    <input required type="date" className="w-full p-2 border rounded-lg"
                      value={form.startDate} onChange={e => setForm({...form, startDate: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-600 mb-1">End Date</label>
                    <input required type="date" className="w-full p-2 border rounded-lg"
                      value={form.endDate} onChange={e => setForm({...form, endDate: e.target.value})} />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Daily Rate (Override Allowed)</label>
                  <div className="relative">
                    <span className="absolute left-3 top-2 text-slate-400">$</span>
                    <input required type="number" className="w-full pl-7 p-2 border rounded-lg font-mono text-slate-700"
                      value={form.rate} onChange={e => setForm({...form, rate: e.target.value})} />
                  </div>
                  <p className="text-xs text-slate-400 mt-1">Default is based on machine configuration.</p>
                </div>

                <div className="flex gap-3 pt-4">
                  <button type="button" onClick={onCancel} className="flex-1 p-3 text-slate-600 hover:bg-slate-50 rounded-lg font-medium">Cancel</button>
                  <button type="submit" className="flex-1 p-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-sm">Confirm Rental</button>
                </div>
              </form>
            </div>
          );
        };

        // 3. Maintenance Tracker Screen (Redesigned)
        const MaintenanceTracker = ({ machines, maintenanceEvents, onSchedule }) => {
          const [scheduleForm, setScheduleForm] = useState({
            machineId: machines[0]?.id || '',
            date: '',
            description: '',
            cost: ''
          });
          
          // State for handling completion of a specific machine
          const [completingId, setCompletingId] = useState(null);
          const [completionData, setCompletionData] = useState({ date: '', cost: '', description: '' });

          const today = useMemo(() => {
              const d = new Date();
              return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          }, []);

          // Sort machines by next maintenance date (Earliest first)
          const sortedMachines = useMemo(() => {
            return [...machines].sort((a, b) => {
                const dateA = a.maintenance?.nextDate || '9999-12-31';
                const dateB = b.maintenance?.nextDate || '9999-12-31';
                return dateA.localeCompare(dateB);
            });
          }, [machines]);

          // Filter completed history
          const historyEvents = useMemo(() => {
            return (maintenanceEvents || [])
                .filter(ev => ev.status === 'complete')
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first
          }, [maintenanceEvents]);

          // Handler for the "Schedule Future" form
          const handleScheduleSubmit = (e) => {
            e.preventDefault();
            if(!scheduleForm.machineId || !scheduleForm.date) return;
            
            onSchedule({
                ...scheduleForm,
                actionType: 'schedule',
                cost: Number(scheduleForm.cost)
            });
            // Reset description/cost but keep machine/date handy or reset all
            setScheduleForm(prev => ({ ...prev, description: '', cost: '' }));
          };

          // Handler for initializing completion mode for a specific machine
          const startCompletion = (machine) => {
            setCompletingId(machine.id);
            setCompletionData({
                date: today,
                cost: '',
                description: 'Routine Maintenance'
            });
          };

          // Handler for submitting the completion
          const submitCompletion = (machineId) => {
             onSchedule({
                 machineId,
                 date: completionData.date,
                 description: completionData.description,
                 cost: Number(completionData.cost),
                 actionType: 'complete'
             });
             setCompletingId(null);
          };

          const getStatusColor = (nextDate) => {
            if (!nextDate) return 'bg-slate-100 text-slate-500';
            if (nextDate < today) return 'bg-red-100 text-red-700 border-red-200';
            const daysUntil = (new Date(nextDate) - new Date(today)) / (1000 * 60 * 60 * 24);
            if (daysUntil <= 7) return 'bg-amber-100 text-amber-700 border-amber-200';
            return 'bg-green-100 text-green-700 border-green-200';
          };

          return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fadeIn items-start">
              
              {/* SECTION 1: SCHEDULE FUTURE MAINTENANCE */}
              <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-2">
                  <CalendarIcon className="w-5 h-5 text-blue-600" /> Schedule Future
                </h2>
                <form onSubmit={handleScheduleSubmit} className="space-y-4">
                  <div>
                    <label className="block text-xs font-bold uppercase text-slate-500 mb-1">Machine</label>
                    <select className="w-full p-2 border rounded-lg bg-slate-50 text-sm"
                      value={scheduleForm.machineId} 
                      onChange={e => setScheduleForm({...scheduleForm, machineId: e.target.value})}>
                      {machines.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-bold uppercase text-slate-500 mb-1">Scheduled Date</label>
                    <input required type="date" className="w-full p-2 border rounded-lg text-sm"
                      value={scheduleForm.date} onChange={e => setScheduleForm({...scheduleForm, date: e.target.value})} />
                  </div>
                  <div>
                     <label className="block text-xs font-bold uppercase text-slate-500 mb-1">Task Details</label>
                     <input required type="text" className="w-full p-2 border rounded-lg text-sm" placeholder="e.g. 500hr Service"
                      value={scheduleForm.description} onChange={e => setScheduleForm({...scheduleForm, description: e.target.value})} />
                  </div>
                  <div>
                     <label className="block text-xs font-bold uppercase text-slate-500 mb-1">Est. Cost ($)</label>
                     <input type="number" className="w-full p-2 border rounded-lg text-sm" placeholder="0.00"
                      value={scheduleForm.cost} onChange={e => setScheduleForm({...scheduleForm, cost: e.target.value})} />
                  </div>
                  <button type="submit" className="w-full mt-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                    <Plus size={16}/> Add to Schedule
                  </button>
                </form>
              </div>

              {/* SECTION 2: UPCOMING MAINTENANCE (Actionable) */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full max-h-[600px]">
                <div className="p-4 border-b border-slate-100 bg-slate-50">
                  <h3 className="font-bold text-slate-700 flex items-center gap-2">
                    <Clock className="w-4 h-4 text-amber-600" /> Upcoming / Due
                  </h3>
                </div>
                <div className="divide-y divide-slate-100 overflow-y-auto flex-1">
                  {sortedMachines.map(m => {
                    const statusClass = getStatusColor(m.maintenance.nextDate);
                    const isOverdue = m.maintenance.nextDate < today;
                    const isCompleting = completingId === m.id;
                    
                    return (
                      <div key={m.id} className={`p-4 transition-colors ${isCompleting ? 'bg-green-50' : 'hover:bg-slate-50'}`}>
                        {!isCompleting ? (
                            // Default View
                            <div className="flex flex-col gap-3">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h4 className="font-bold text-sm text-slate-800">{m.name}</h4>
                                        <p className="text-xs text-slate-500">{m.type} â€¢ {m.maintenance.frequency}</p>
                                    </div>
                                    <div className={`px-2 py-1 rounded text-[10px] font-bold border uppercase tracking-wide ${statusClass}`}>
                                        {isOverdue ? 'Overdue' : 'Due'}: {formatDate(m.maintenance.nextDate)}
                                    </div>
                                </div>
                                <button 
                                    onClick={() => startCompletion(m)}
                                    className="w-full py-1.5 px-3 bg-white border border-green-200 text-green-700 text-xs font-medium rounded hover:bg-green-50 transition-colors flex items-center justify-center gap-2"
                                >
                                    <CheckSquare size={14} /> Mark as Completed
                                </button>
                            </div>
                        ) : (
                            // Completion Form View (Inline)
                            <div className="space-y-3 animate-fadeIn">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-bold text-sm text-green-800">Complete: {m.name}</h4>
                                    <button onClick={() => setCompletingId(null)}><X size={16} className="text-slate-400 hover:text-slate-600"/></button>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase">Date</label>
                                        <input type="date" className="w-full p-1 border rounded text-xs" 
                                            value={completionData.date} 
                                            onChange={e => setCompletionData({...completionData, date: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase">Cost ($)</label>
                                        <input type="number" className="w-full p-1 border rounded text-xs" placeholder="0.00"
                                            value={completionData.cost} 
                                            onChange={e => setCompletionData({...completionData, cost: e.target.value})}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">Notes</label>
                                    <input type="text" className="w-full p-1 border rounded text-xs" placeholder="What was done?"
                                        value={completionData.description} 
                                        onChange={e => setCompletionData({...completionData, description: e.target.value})}
                                    />
                                </div>
                                <button 
                                    onClick={() => submitCompletion(m.id)}
                                    className="w-full py-2 bg-green-600 text-white text-xs font-bold rounded shadow-sm hover:bg-green-700"
                                >
                                    Confirm & Advance Schedule
                                </button>
                            </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* SECTION 3: COMPLETED HISTORY */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full max-h-[600px]">
                <div className="p-4 border-b border-slate-100 bg-slate-50">
                  <h3 className="font-bold text-slate-700 flex items-center gap-2">
                    <History className="w-4 h-4 text-slate-500" /> History Log
                  </h3>
                </div>
                <div className="divide-y divide-slate-100 overflow-y-auto flex-1">
                    {historyEvents.length === 0 ? (
                        <div className="p-8 text-center text-slate-400 text-sm italic">No history yet.</div>
                    ) : (
                        historyEvents.map((ev, idx) => {
                            const machine = machines.find(m => m.id === ev.machineId);
                            return (
                                <div key={ev.id || idx} className="p-4 hover:bg-slate-50 flex justify-between items-start group">
                                    <div>
                                        <div className="font-medium text-sm text-slate-800">{machine?.name || 'Unknown Machine'}</div>
                                        <div className="text-xs text-slate-500 mt-0.5">{ev.description}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded">{formatDate(ev.date)}</div>
                                        {ev.cost > 0 && <div className="text-xs text-slate-400 font-mono mt-1">${ev.cost}</div>}
                                    </div>
                                </div>
                            )
                        })
                    )}
                </div>
              </div>

            </div>
          );
        };

        // 4. Calendar View
        const CalendarView = ({ machines, transactions, maintenanceEvents }) => {
          const [currentDate, setCurrentDate] = useState(new Date());
          const [selectedMachineId, setSelectedMachineId] = useState('all');

          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();

          const daysInMonth = getDaysInMonth(year, month);
          const startDay = getFirstDayOfMonth(year, month);
          
          const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
          const emptyDays = Array.from({ length: startDay }, (_, i) => i);

          // Combine Transactions (rentals) and Maintenance Events
          const allEvents = useMemo(() => {
              const rentals = transactions.filter(t => t.type === 'rental');
              const maintenance = maintenanceEvents.map(m => ({
                  ...m,
                  type: 'maintenance',
                  startDate: m.date,
                  endDate: m.date,
                  rate: m.cost
              }));
              return [...rentals, ...maintenance];
          }, [transactions, maintenanceEvents]);

          // Filter events
          const monthEvents = useMemo(() => {
            return allEvents.filter(t => {
              const tStart = new Date(t.startDate);
              const tEnd = new Date(t.endDate);
              const mStart = new Date(year, month, 1);
              const mEnd = new Date(year, month + 1, 0);
              
              const machineMatch = selectedMachineId === 'all' || t.machineId === selectedMachineId;
              const dateOverlap = tStart <= mEnd && tEnd >= mStart;
              
              return machineMatch && dateOverlap;
            });
          }, [allEvents, year, month, selectedMachineId]);

          const getEventsForDay = (day) => {
            const dateStr = new Date(year, month, day).toISOString().split('T')[0];
            return monthEvents.filter(t => t.startDate <= dateStr && t.endDate >= dateStr);
          };

          const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
          const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));

          return (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              {/* Calendar Header */}
              <div className="p-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50">
                <div className="flex items-center gap-4">
                  <button onClick={prevMonth} className="p-1 hover:bg-slate-200 rounded"><ChevronLeft className="w-5 h-5 text-slate-600"/></button>
                  <h2 className="text-lg font-bold text-slate-800 w-32 text-center">
                    {currentDate.toLocaleDateString('default', { month: 'long', year: 'numeric' })}
                  </h2>
                  <button onClick={nextMonth} className="p-1 hover:bg-slate-200 rounded"><ChevronRight className="w-5 h-5 text-slate-600"/></button>
                </div>

                <div className="flex items-center gap-2 w-full sm:w-auto">
                  <span className="text-sm font-medium text-slate-500 whitespace-nowrap">Filter:</span>
                  <select 
                    className="p-2 border rounded-lg text-sm bg-white shadow-sm w-full sm:w-64 outline-none focus:ring-1 focus:ring-blue-500"
                    value={selectedMachineId}
                    onChange={(e) => setSelectedMachineId(e.target.value)}
                  >
                    <option value="all">All Equipment</option>
                    {machines.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                  </select>
                </div>
              </div>

              {/* Calendar Grid */}
              <div className="grid grid-cols-7 text-center border-b border-slate-100 bg-slate-50 text-xs font-semibold text-slate-400 py-2">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
              </div>
              <div className="grid grid-cols-7 auto-rows-fr bg-slate-100 gap-px">
                {emptyDays.map(d => <div key={`empty-${d}`} className="bg-white min-h-[100px]" />)}
                
                {daysArray.map(day => {
                  const events = getEventsForDay(day);
                  const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                  
                  return (
                    <div key={day} className={`bg-white min-h-[100px] p-2 hover:bg-slate-50 transition-colors ${isToday ? 'bg-blue-50/30' : ''}`}>
                      <div className={`text-sm font-medium mb-1 ${isToday ? 'text-blue-600' : 'text-slate-700'}`}>{day}</div>
                      <div className="space-y-1">
                        {events.map((ev, idx) => {
                           const machine = machines.find(m => m.id === ev.machineId);
                           const isMaintenance = ev.type === 'maintenance';
                           return (
                             <div key={idx} 
                                className={`text-[10px] p-1 rounded border truncate
                                ${isMaintenance 
                                  ? 'bg-amber-100 border-amber-200 text-amber-800' 
                                  : 'bg-blue-100 border-blue-200 text-blue-800'}`}
                                title={`${machine?.name} - ${isMaintenance ? ev.description : ev.customer}`}
                              >
                               <span className="font-bold">{machine?.name.split(' ')[0]}</span>: {isMaintenance ? ev.description : ev.customer}
                             </div>
                           )
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        };

        // 5. Performance View
        const PerformanceView = ({ machines, transactions, maintenanceEvents }) => {
            // Current Month Metrics
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const monthStart = new Date(currentYear, currentMonth, 1);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);

            const metrics = useMemo(() => {
                return machines.map(m => {
                    // 1. Calculate Booked Days for this month
                    let bookedDays = 0;
                    let rentalIncome = 0;
                    let maintenanceCost = 0;

                    // Process Rentals from Transactions
                    const machineRentals = transactions.filter(t => t.machineId === m.id && t.type === 'rental');
                    machineRentals.forEach(t => {
                        const tStart = new Date(t.startDate);
                        const tEnd = new Date(t.endDate);

                        // Start of overlap: max(tx_start, month_start)
                        const startOverlap = tStart < monthStart ? monthStart : tStart;
                        // End of overlap: min(tx_end, month_end)
                        const endOverlap = tEnd > monthEnd ? monthEnd : tEnd;

                        if (startOverlap <= endOverlap) {
                                const days = (endOverlap - startOverlap) / (1000 * 60 * 60 * 24) + 1;
                                bookedDays += days;
                                rentalIncome += (days * t.rate);
                        }
                    });
                    
                    // Process Maintenance Costs from Maintenance Collection
                    const machineMaint = maintenanceEvents.filter(me => me.machineId === m.id);
                    machineMaint.forEach(me => {
                        const meDate = new Date(me.date);
                        if (meDate >= monthStart && meDate <= monthEnd) {
                            maintenanceCost += (me.cost || 0);
                        }
                    });

                    const vacantDays = daysInMonth - bookedDays;
                    const loanCost = m.loan.active ? m.loan.payment : 0;
                    const totalExpenses = loanCost + maintenanceCost;
                    const netProfit = rentalIncome - totalExpenses;

                    return {
                        ...m,
                        bookedDays,
                        vacantDays,
                        rentalIncome,
                        totalExpenses,
                        netProfit
                    };
                });
            }, [machines, transactions, maintenanceEvents, currentYear, currentMonth]);

            const totals = metrics.reduce((acc, curr) => ({
                revenue: acc.revenue + curr.rentalIncome,
                expenses: acc.expenses + curr.totalExpenses,
                profit: acc.profit + curr.netProfit
            }), { revenue: 0, expenses: 0, profit: 0 });

            return (
                <div className="space-y-6 animate-fadeIn">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="text-sm font-medium text-slate-500">Total Revenue</p>
                                    <h3 className="text-2xl font-bold text-slate-800 mt-1">${totals.revenue.toLocaleString()}</h3>
                                </div>
                                <div className="bg-green-100 p-2 rounded-lg text-green-600"><TrendingUp size={20}/></div>
                            </div>
                        </div>
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="text-sm font-medium text-slate-500">Total Expenses</p>
                                    <h3 className="text-2xl font-bold text-slate-800 mt-1">${totals.expenses.toLocaleString()}</h3>
                                    <p className="text-xs text-slate-400 mt-1">Loans & Maintenance</p>
                                </div>
                                <div className="bg-red-100 p-2 rounded-lg text-red-600"><TrendingDown size={20}/></div>
                            </div>
                        </div>
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="text-sm font-medium text-slate-500">Net Profit</p>
                                    <h3 className={`text-2xl font-bold mt-1 ${totals.profit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {totals.profit >= 0 ? '+' : ''}${totals.profit.toLocaleString()}
                                    </h3>
                                </div>
                                <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><BarChart3 size={20}/></div>
                            </div>
                        </div>
                    </div>

                    {/* Detailed Table */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50">
                            <h3 className="font-bold text-slate-700">Monthly Performance Breakdown ({currentDate.toLocaleString('default', { month: 'long' })})</h3>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                    <tr>
                                        <th className="p-4">Machine</th>
                                        <th className="p-4">Utilization (Days)</th>
                                        <th className="p-4 text-right">Revenue</th>
                                        <th className="p-4 text-right">Expenses</th>
                                        <th className="p-4 text-right">Net Profit</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {metrics.map(m => (
                                        <tr key={m.id} className="hover:bg-slate-50">
                                            <td className="p-4 font-medium text-slate-800">
                                                {m.name}
                                                <div className="text-xs text-slate-400 font-normal">{m.type}</div>
                                            </td>
                                            <td className="p-4">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="font-bold text-slate-700">{Math.round(m.bookedDays)}</span>
                                                    <span className="text-slate-400">/ {daysInMonth} days</span>
                                                </div>
                                                <div className="w-24 h-2 bg-slate-100 rounded-full overflow-hidden">
                                                    <div 
                                                        className={`h-full rounded-full ${m.bookedDays > 20 ? 'bg-green-500' : m.bookedDays > 10 ? 'bg-amber-400' : 'bg-slate-300'}`} 
                                                        style={{ width: `${(m.bookedDays / daysInMonth) * 100}%` }}
                                                    />
                                                </div>
                                            </td>
                                            <td className="p-4 text-right text-green-600 font-mono">
                                                ${m.rentalIncome.toLocaleString()}
                                            </td>
                                            <td className="p-4 text-right text-red-500 font-mono">
                                                ${m.totalExpenses.toLocaleString()}
                                            </td>
                                            <td className={`p-4 text-right font-bold font-mono ${m.netProfit >= 0 ? 'text-slate-800' : 'text-red-600'}`}>
                                                ${m.netProfit.toLocaleString()}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
          const [user, setUser] = useState(null);
          const [view, setView] = useState('calendar'); 
          const [machines, setMachines] = useState([]);
          const [transactions, setTransactions] = useState([]);
          const [maintenanceEvents, setMaintenanceEvents] = useState([]);
          const [authError, setAuthError] = useState(null);
          const [permissionError, setPermissionError] = useState(false);
          const [isSeeding, setIsSeeding] = useState(false);
          
          // Editing state
          const [editingId, setEditingId] = useState(null);
          // UPDATED: State object to hold multiple edit fields
          const [editValues, setEditValues] = useState({ rate: '', payment: '', interest: '' });

          // --- Auth & Data Loading ---
          useEffect(() => {
            const initAuth = async () => {
              try {
                // Since we are using a specific custom Firebase project (equipmenttracker-857f8),
                // the environment's __initial_auth_token (which is for the Canvas sandbox) will fail 
                // with 'auth/custom-token-mismatch'. 
                // We must strictly use Anonymous auth for this custom configuration.
                await signInAnonymously(auth);
              } catch (e) {
                console.error("Auth Failed:", e);
                setAuthError(e.message);
              }
            };
            initAuth();
            
            return onAuthStateChanged(auth, (u) => setUser(u));
          }, []);

          // --- Seeding & Subscription ---
          useEffect(() => {
            if (!user) return;

            // Updated to root-level collections
            const machinesRef = collection(db, 'machines');
            const transRef = collection(db, 'transactions');
            const maintRef = collection(db, 'maintenance');

            // Permission Error Handler
            const handlePermissionError = (err) => {
                console.error("Data fetch error:", err);
                if (err.code === 'permission-denied') {
                    setPermissionError(true);
                }
            };

            // 2. Subscribe to Machines
            const unsubMachines = onSnapshot(machinesRef, (snapshot) => {
               setMachines(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
            }, handlePermissionError);

            // 3. Subscribe to Transactions
            const unsubTrans = onSnapshot(transRef, (snapshot) => {
               setTransactions(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
            }, handlePermissionError);

            // 4. Subscribe to Maintenance
            const unsubMaint = onSnapshot(maintRef, (snapshot) => {
               setMaintenanceEvents(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
            }, handlePermissionError);

            return () => {
              unsubMachines();
              unsubTrans();
              unsubMaint();
            };
          }, [user]);

          // Manual Seed Function
          const handleSeedData = async () => {
            if (!user || isSeeding) return;
            setIsSeeding(true);
            
            try {
                console.log("Starting Manual Seed...");
                const batch = writeBatch(db);
                
                // Seed Machines (Root Level)
                SEED_MACHINES.forEach(m => {
                   const ref = doc(db, 'machines', m.id);
                   batch.set(ref, m);
                });

                // Seed Transactions (Root Level)
                SEED_TRANSACTIONS.forEach(t => {
                   const ref = doc(collection(db, 'transactions'));
                   batch.set(ref, t);
                });
                
                // Seed Maintenance (Root Level)
                SEED_MAINTENANCE.forEach(m => {
                   const ref = doc(collection(db, 'maintenance'));
                   batch.set(ref, m);
                });

                await batch.commit();
                console.log("Database seeded successfully!");
                // Force view refresh or just let listeners handle it
            } catch (err) {
                console.error("Seeding failed:", err);
                if (err.code === 'permission-denied') {
                    setPermissionError(true);
                } else {
                    alert("Seeding failed: " + err.message);
                }
            } finally {
                setIsSeeding(false);
            }
          };

          // Automatic Seed Check on Load
          useEffect(() => {
             if (!user) return;
             // Check if empty and seed automatically once
             const checkAndSeed = async () => {
                 const machinesRef = collection(db, 'machines');
                 try {
                    const snap = await getDocs(machinesRef);
                    if (snap.empty) {
                        handleSeedData();
                    }
                 } catch (e) {
                     console.log("Auto-seed check failed (likely permissions), skipping.");
                 }
             };
             checkAndSeed();
          }, [user]); // Run once when user is authenticated


          // --- Actions ---

          const handleAddMachine = async (newMachine) => {
            if (!user) return;
            try {
              await addDoc(collection(db, 'machines'), newMachine);
              setView('list');
            } catch (e) { console.error("Error adding machine: ", e); }
          };

          const handleRent = async (newTx) => {
            if (!user) return;
            try {
              await addDoc(collection(db, 'transactions'), newTx);
              setView('calendar');
            } catch (e) { console.error("Error renting: ", e); }
          };

          const handleScheduleMaintenance = async ({ machineId, date, description, cost, actionType }) => {
            if (!user) return;
            const newTx = {
              machineId,
              description,
              date,
              cost,
              status: actionType, // 'schedule' or 'complete'
              ...(actionType === 'complete' && { completedAt: new Date().toISOString() }) // Add timestamp if completed
            };

            try {
              // 1. Add to MAINTENANCE Collection
              await addDoc(collection(db, 'maintenance'), newTx);
              
              // 2. Update Machine Next Date
              const machine = machines.find(m => m.id === machineId);
              if (machine) {
                let nextDt;
                
                if (actionType === 'complete') {
                    // If completing, advance to the NEXT cycle
                    nextDt = new Date(date);
                    if (machine.maintenance.frequency === 'Weekly') nextDt.setDate(nextDt.getDate() + 7);
                    else if (machine.maintenance.frequency === 'Monthly') nextDt.setMonth(nextDt.getMonth() + 1);
                    else if (machine.maintenance.frequency === 'Quarterly') nextDt.setMonth(nextDt.getMonth() + 3);
                    else if (machine.maintenance.frequency === 'Annually') nextDt.setFullYear(nextDt.getFullYear() + 1);
                } else {
                    // If just scheduling, set the reminder to the specific date chosen
                    nextDt = new Date(date);
                }
                
                await updateDoc(doc(db, 'machines', machineId), {
                   'maintenance.nextDate': nextDt.toISOString().split('T')[0]
                });
              }
              alert(actionType === 'complete' ? 'Maintenance completed & next cycle scheduled!' : 'Maintenance scheduled!');
            } catch (e) { console.error("Error maint: ", e); }
          };
          
          // UPDATED: Save function now updates rate, payment, and interest
          const saveEdit = async (id) => {
            if (!user) return;
            try {
              const payment = Number(editValues.payment);
              await updateDoc(doc(db, 'machines', id), {
                baseRate: Number(editValues.rate),
                'loan.payment': payment,
                'loan.interest': Number(editValues.interest),
                'loan.active': payment > 0 // Automatically activate loan if payment is set > 0
              });
              setEditingId(null);
            } catch (e) { console.error("Error updating machine details: ", e); }
          };

          // Calculate some simple stats
          const activeRentals = useMemo(() => transactions.filter(t => {
            const today = new Date().toISOString().split('T')[0];
            return t.startDate <= today && t.endDate >= today && t.type === 'rental';
          }).length, [transactions]);
          
          const upcomingMaintenance = useMemo(() => machines.filter(m => {
              const today = new Date().toISOString().split('T')[0];
              const nextDate = m.maintenance.nextDate;
              const diffTime = new Date(nextDate) - new Date(today);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
              return diffDays <= 7 && diffDays >= -30;
          }).length, [machines]);

          if (permissionError) {
            return (
                <div className="flex h-screen items-center justify-center p-4 bg-red-50 text-red-900 font-sans">
                    <div className="max-w-md bg-white p-6 rounded-lg shadow-xl border border-red-200">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                            <Lock className="text-red-600" /> Database Permissions Error
                        </h2>
                        <p className="mb-4 text-sm">
                            Your app is connected to Firebase, but the database is blocking access. 
                            This usually happens when <strong>Firestore Rules</strong> are set to "production" (locked) mode.
                        </p>
                        <div className="bg-slate-100 p-3 rounded mb-4 text-xs font-mono overflow-x-auto whitespace-pre">
rules_version = '2';{'\n'}
service cloud.firestore &#123;{'\n'}
&nbsp;&nbsp;match /databases/&#123;database&#125;/documents &#123;{'\n'}
&nbsp;&nbsp;&nbsp;&nbsp;match /&#123;document=**&#125; &#123;{'\n'}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if request.auth != null;{'\n'}
&nbsp;&nbsp;&nbsp;&nbsp;&#125;{'\n'}
&nbsp;&nbsp;&#125;{'\n'}
&#125;
                        </div>
                        <p className="text-sm">
                            Go to <strong>Firebase Console &gt; Firestore Database &gt; Rules</strong> and paste the code above to allow authenticated users (like this app) to access data.
                        </p>
                        <button 
                            onClick={() => window.location.reload()}
                            className="mt-4 w-full bg-red-600 text-white p-2 rounded hover:bg-red-700 font-bold"
                        >
                            I've Updated Rules, Retry
                        </button>
                    </div>
                </div>
            )
          }

          if (!user) {
            return (
                <div className="flex h-screen flex-col items-center justify-center text-slate-500 p-4">
                    <div className="mb-4 animate-pulse">Connecting to Database...</div>
                    {authError && (
                        <div className="bg-red-50 border border-red-200 text-red-600 p-4 rounded-lg max-w-md text-sm">
                            <p className="font-bold mb-1">Connection Failed</p>
                            <p className="mb-2">Error: {authError}</p>
                            <p className="text-xs text-red-500">
                                Tip: If using your own Firebase project, go to <strong>Firebase Console &gt; Authentication &gt; Sign-in method</strong> and enable <strong>Anonymous</strong> sign-in.
                            </p>
                        </div>
                    )}
                </div>
            );
          }

          return (
            <div className="min-h-screen bg-slate-100 font-sans text-slate-800">
              {/* Top Navigation Bar */}
              <nav className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
                <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-yellow-500 p-2 rounded-lg text-slate-900 font-bold">EQ</div>
                    <h1 className="text-xl font-bold tracking-tight">EquipTrack Pro</h1>
                  </div>
                  <div className="flex gap-2 bg-slate-800 p-1 rounded-lg overflow-x-auto max-w-full">
                    <button 
                      onClick={() => setView('calendar')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap ${view === 'calendar' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                    >
                      Calendar
                    </button>
                    <button 
                      onClick={() => setView('list')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap ${view === 'list' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                    >
                      Fleet List
                    </button>
                    <button 
                      onClick={() => setView('performance')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap ${view === 'performance' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                    >
                      Performance
                    </button>
                    <button 
                      onClick={() => setView('maintenance')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap ${view === 'maintenance' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                    >
                      Maintenance
                    </button>
                    <button 
                      onClick={() => setView('rent')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap ${view === 'rent' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                    >
                      New Rental
                    </button>
                    <button 
                      onClick={() => setView('add')}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all whitespace-nowrap ${view === 'add' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                    >
                      Add Machine
                    </button>
                  </div>
                </div>
              </nav>

              {/* Main Content Area */}
              <main className="max-w-6xl mx-auto p-4 md:p-6">
                
                {/* Dashboard Status Bar */}
                {(view === 'calendar' || view === 'maintenance') && (
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                      <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Truck size={20}/></div>
                      <div>
                        <p className="text-xs text-slate-500 font-bold uppercase">Total Fleet</p>
                        <p className="text-xl font-bold">{machines.length}</p>
                      </div>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                      <div className="bg-green-100 p-3 rounded-full text-green-600"><CheckCircle size={20}/></div>
                      <div>
                        <p className="text-xs text-slate-500 font-bold uppercase">Active Rentals</p>
                        <p className="text-xl font-bold">{activeRentals}</p>
                      </div>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                      <div className="bg-amber-100 p-3 rounded-full text-amber-600"><AlertTriangle size={20}/></div>
                      <div>
                        <p className="text-xs text-slate-500 font-bold uppercase">Maint. Due Soon</p>
                        <p className="text-xl font-bold">{upcomingMaintenance}</p>
                      </div>
                    </div>
                  </div>
                )}

                {/* View Switcher */}
                {view === 'add' && <AddMachine onAdd={handleAddMachine} onCancel={() => setView('calendar')} />}
                
                {view === 'rent' && <RentMachine machines={machines} onRent={handleRent} onCancel={() => setView('calendar')} />}
                
                {view === 'maintenance' && <MaintenanceTracker machines={machines} maintenanceEvents={maintenanceEvents} onSchedule={handleScheduleMaintenance} />}

                {view === 'performance' && <PerformanceView machines={machines} transactions={transactions} maintenanceEvents={maintenanceEvents} />}
                
                {view === 'calendar' && <CalendarView machines={machines} transactions={transactions} maintenanceEvents={maintenanceEvents} />}

                {view === 'list' && (
                  <div className="space-y-4">
                    <h2 className="text-xl font-bold text-slate-800 mb-4">Fleet Inventory</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {machines.map(m => (
                        <div key={m.id} className={`bg-white p-5 rounded-xl border shadow-sm transition-shadow ${editingId === m.id ? 'border-blue-300 ring-1 ring-blue-100' : 'border-slate-200 hover:shadow-md'}`}>
                          <div className="flex justify-between items-start mb-3">
                            <div>
                              <h3 className="font-bold text-lg text-slate-800">{m.name}</h3>
                              <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full">{m.type}</span>
                            </div>
                            
                            <div className="text-right">
                              {editingId === m.id ? (
                                <div className="flex flex-col items-end gap-2">
                                   <div className="flex items-center gap-1">
                                       <span className="text-slate-400 text-sm font-bold">$</span>
                                       <input 
                                          type="number" 
                                          value={editValues.rate}
                                          onChange={(e) => setEditValues({...editValues, rate: e.target.value})}
                                          className="w-20 p-1 border border-blue-300 rounded text-sm font-mono text-right focus:outline-none focus:ring-1 focus:ring-blue-500"
                                          placeholder="Rate"
                                       />
                                   </div>
                                   <div className="flex gap-1">
                                       <button onClick={() => saveEdit(m.id)} className="p-1.5 bg-green-100 text-green-700 hover:bg-green-200 rounded transition-colors"><Save size={16}/></button>
                                       <button onClick={() => setEditingId(null)} className="p-1.5 bg-red-100 text-red-600 hover:bg-red-200 rounded transition-colors"><X size={16}/></button>
                                   </div>
                                </div>
                              ) : (
                                <div className="flex items-center justify-end gap-2 group">
                                  <p className="font-mono font-bold text-green-600">${m.baseRate}<span className="text-xs text-slate-400 font-sans">/day</span></p>
                                  <button 
                                    onClick={() => { 
                                        setEditingId(m.id); 
                                        setEditValues({ 
                                            rate: m.baseRate, 
                                            payment: m.loan?.payment || 0, 
                                            interest: m.loan?.interest || 0 
                                        }); 
                                    }}
                                    className="text-slate-400 hover:text-blue-600 p-1 transition-colors"
                                    title="Edit Machine Details"
                                  >
                                    <Pencil size={14} />
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                          
                          <div className="space-y-2 mt-4 pt-4 border-t border-slate-100">
                            <div className="flex items-center gap-2 text-sm text-slate-600 h-8">
                              <DollarSign size={14} className={m.loan.active ? "text-red-500 shrink-0" : "text-slate-300 shrink-0"} />
                              
                              {editingId === m.id ? (
                                  <div className="flex items-center gap-2 w-full">
                                      <div className="relative flex-1">
                                          <span className="absolute left-1.5 top-1/2 -translate-y-1/2 text-[10px] text-slate-400">$</span>
                                          <input 
                                              type="number"
                                              value={editValues.payment}
                                              onChange={(e) => setEditValues({...editValues, payment: e.target.value})}
                                              className="w-full pl-3 p-1 border border-slate-300 rounded text-xs"
                                              placeholder="Mo. Pmt"
                                          />
                                      </div>
                                      <span className="text-slate-400">@</span>
                                      <div className="relative w-16">
                                          <input 
                                              type="number"
                                              step="0.1"
                                              value={editValues.interest}
                                              onChange={(e) => setEditValues({...editValues, interest: e.target.value})}
                                              className="w-full pr-4 p-1 border border-slate-300 rounded text-xs text-right"
                                              placeholder="Int"
                                          />
                                          <span className="absolute right-1.5 top-1/2 -translate-y-1/2 text-[10px] text-slate-400">%</span>
                                      </div>
                                  </div>
                              ) : (
                                  m.loan.active 
                                    ? <span>Loan: <strong>${m.loan.payment}</strong>/mo @ {m.loan.interest}%</span>
                                    : <span className="text-green-600 font-medium">Paid Off</span>
                              )}
                            </div>
                            <div className="flex items-center gap-2 text-sm text-slate-600">
                              <Wrench size={14} className="text-amber-500 shrink-0" />
                              <span>Next Maint: {formatDate(m.maintenance.nextDate)} ({m.maintenance.frequency})</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    {machines.length === 0 && (
                      <div className="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                        <p className="text-slate-400 mb-4">No equipment found in database.</p>
                        <div className="flex flex-col gap-2 items-center">
                            <button 
                                onClick={() => setView('add')} 
                                className="text-blue-600 font-medium hover:underline"
                            >
                                Add your first machine manually
                            </button>
                            <span className="text-slate-300 text-xs">or</span>
                            <button 
                                onClick={handleSeedData} 
                                disabled={isSeeding}
                                className="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-medium hover:bg-slate-700 disabled:opacity-50"
                            >
                                {isSeeding ? 'Seeding Database...' : 'Populate with Sample Data'}
                            </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

              </main>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>